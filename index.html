<!doctype html>
<html>
<head>
  <title>GoLTGen with WebGL shader</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <canvas id="game"></canvas>

  <form class="control" id="createGameSettings">
    <h2>GoLTGen-Web</h2>
    <hr>
    <span><b>Board:&nbsp;</b></span>
    <span>Size X:&nbsp;
      <input id="resolutionX" name="resolutionX" type="number" value="192" placeholder="192"/>
      &nbsp;px&nbsp;&nbsp;
    </span>
    <span>Size Y:&nbsp;
      <input id="resolutionY" name="resolutionY" type="number" value="108" placeholder="108"/>
      &nbsp;px&nbsp;&nbsp;
    </span>
    <span>Array X:&nbsp;
      <input id="arrayX" name="arrayX" type="number" value="1" placeholder="1"/>
      &nbsp;&nbsp;
    </span>
    <span>Array Y:&nbsp;
      <input id="arrayY" name="arrayY" type="number" value="1" placeholder="1"/>
      &nbsp;&nbsp;
    </span>
    <br>
    <hr>
    <span><b>Game:&nbsp;</b></span>
    <span>Speed:&nbsp;
      <input id="iterationTime" name="iterationTime" type="number" value="50" placeholder="50"/>
      &nbsp;ms&nbsp;&nbsp;
    </span>
    <span id="fps"></span>
    <span>Neighborhood:&nbsp;&nbsp;
      <input id="neighborhood_size" name="neighborhood_size" type="number" value="1" placeholder="1"/>
      &nbsp;
    </span>
    <br>
    <hr>
    <span><b>Start Condition:&nbsp;</b></span>
    <span>
      <select id="startCondition" name="startCondition">
        <option value="squareSeed">Square</option>
        <option value="rectSeed">Rectangle</option>
        <option value="rectArraySeed">Rectangle Array</option>
        <option value="verticalBarSeed">Vertical Bars</option>
        <option value="horizontalBarSeed">Horizontal Bars</option>
        <option value="circleSeed">Circle</option>
        <option value="circleArraySeed">Circle Array</option>
        <option value="ovalSeed">Oval</option>
        <option value="ringSeed">Ring</option>
        <option value="crossSeed">Cross</option>
        <option value="randomBlobSeed">Random Blob</option>
        <option value="randomSeed">Random</option>
      </select>
      &nbsp;&nbsp;
    </span>
    <span>Size:&nbsp;
      <input id="startConditionModulator" name="startConditionModulator" type="number" value="5" placeholder="5"/>
      &nbsp;&nbsp;
    </span>
    <img src="assets/circle.png" id="gamefieldIcon" />
    <br>
    <hr>
    <span><b>Rules:&nbsp;</b></span>
    <span>Survive:&nbsp;
      <input id="survive" name="survive" type="string" style="" value="1, 2, 3, 4, 5" placeholder="1-9"/>
      &nbsp;&nbsp;
    </span>
    <span>Birth:&nbsp;
      <input id="birth" name="birth" type="string" value="3" placeholder="1-9"/>
      &nbsp;&nbsp;
    </span>
    <span>Natural&nbsp;Death&nbsp;at:&nbsp;
      <input id="naturalDeath" name="naturalDeath" type="number" value="200" placeholder="0-255"/>
      &nbsp;iterations&nbsp;&nbsp;
    </span>
    <br>
    <hr>
    <span><b>Colors:&nbsp;</b></span>
    <span>Palette:
      <select id="colormap" name="colormap">
        <option value=Accent>Accent</option>
        <option value=Blues>Blues</option>
        <option value=BrBG>BrBG</option>
        <option value=BuGn>BuGn</option>
        <option value=BuPu>BuPu</option>
        <option value=CMRmap>CMRmap</option>
        <option value=Dark2>Dark2</option>
        <option value=GnBu>GnBu</option>
        <option value=Greens>Greens</option>
        <option value=Greys>Greys</option>
        <option value=OrRd>OrRd</option>
        <option value=Oranges>Oranges</option>
        <option value=PRGn>PRGn</option>
        <option value=Paired>Paired</option>
        <option value=Pastel1>Pastel1</option>
        <option value=Pastel2>Pastel2</option>
        <option value=PiYG>PiYG</option>
        <option value=PuBu>PuBu</option>
        <option value=PuBuGn>PuBuGn</option>
        <option value=PuOr>PuOr</option>
        <option value=PuRd>PuRd</option>
        <option value=Purples>Purples</option>
        <option value=RdBu>RdBu</option>
        <option value=RdGy>RdGy</option>
        <option value=RdPu>RdPu</option>
        <option value=RdYlBu>RdYlBu</option>
        <option value=RdYlGn>RdYlGn</option>
        <option value=Reds>Reds</option>
        <option value=Set1>Set1</option>
        <option value=Set2>Set2</option>
        <option value=Set3>Set3</option>
        <option value=Spectral>Spectral</option>
        <option value=Wistia>Wistia</option>
        <option value=YlGn>YlGn</option>
        <option value=YlGnBu>YlGnBu</option>
        <option value=YlOrBr>YlOrBr</option>
        <option value=YlOrRd>YlOrRd</option>
        <option value=afmhot>afmhot</option>
        <option value=autumn>autumn</option>
        <option value=binary>binary</option>
        <option value=bone>bone</option>
        <option value=brg>brg</option>
        <option value=bwr>bwr</option>
        <option value=cividis>cividis</option>
        <option value=cool>cool</option>
        <option value=coolwarm>coolwarm</option>
        <option value=copper>copper</option>
        <option value=cubehelix>cubehelix</option>
        <option value=flag>flag</option>
        <option value=gist_earth>gist_earth</option>
        <option value=gist_gray>gist_gray</option>
        <option value=gist_heat>gist_heat</option>
        <option value=gist_ncar>gist_ncar</option>
        <option value=gist_rainbow>gist_rainbow</option>
        <option value=gist_stern>gist_stern</option>
        <option value=gist_yarg>gist_yarg</option>
        <option value=gnuplot>gnuplot</option>
        <option value=gnuplot2>gnuplot2</option>
        <option value=gray>gray</option>
        <option value=hot>hot</option>
        <option value=hsv>hsv</option>
        <option value=inferno>inferno</option>
        <option value=jet>jet</option>
        <option value=magma>magma</option>
        <option value=nipy_spectral>nipy_spectral</option>
        <option value=ocean>ocean</option>
        <option value=pink>pink</option>
        <option value=plasma>plasma</option>
        <option value=prism>prism</option>
        <option value=rainbow>rainbow</option>
        <option value=seismic>seismic</option>
        <option value=spring>spring</option>
        <option value=summer>summer</option>
        <option value=tab10>tab10</option>
        <option value=tab20>tab20</option>
        <option value=tab20b>tab20b</option>
        <option value=tab20c>tab20c</option>
        <option value=terrain>terrain</option>
        <option value=turbo>turbo</option>
        <option value=twilight>twilight</option>
        <option value=twilight_shifted>twilight_shifted</option>
        <option value=viridis>viridis</option>
        <option value=winter>winter</option>
      </select>&nbsp;&nbsp;
    </span>
    <span>Reverse:&nbsp;
      <input id="reverseColormap" name="reverseColormap" type="checkbox"/>
      &nbsp;&nbsp;
    </span>
    <span>Mirror:&nbsp;
      <input id="mirrorColormap" name="mirrorColormap" type="checkbox"/>
      &nbsp;&nbsp;
    </span>
    <span>Start (age):&nbsp;
      <input id="colormapStart" name="colormapStart" type="number" value="0" placeholder="0"/>
      &nbsp;&nbsp;
    </span>
    <span><b><</b>&nbsp;&nbsp;</span>
    <span>Stop (age):&nbsp;
      <input id="colormapStop" name="colormapStop" type="number" value="200" placeholder="200"/>
      &nbsp;&nbsp;
    </span>
    <hr class="colorPreview">
    <hr>
    <button id="createGame" type="submit"><b>Create Game</b></button>
  </form>
     
  <div class="control" id="presets">
    <h3>Presets</h3>
    <hr>
    <ul id="presetList"></ul>
  </div>

  <div class="control" id="tutorial">
    <h3>Tutorial</h3>
    <hr>
    <span>GoLTGen-Web or GoLTWeb is a webgl2 based Game of Life alike Cellular Automaton. This means that it presents you with a gamefield, rules that apply to a life, lifes, as in cells of the gamefield that are either alive or dead, a start condition and a mean of visualising the cells and their age.</span>
    <hr>
    <span><b>Board</b></span><br>
    <span>The gamefield has to have a defined <b>size</b> in this Cellular Automaton, it can be set via Size X and Size Y. Since pixels within the game are square it may be set to a fraction of your monitors resolution, e.g. 192x108px for a full HD screen. It can both be interesting to set the resolution to a fairly low and fairly high number. You can also experient with different aspect ratios, just be aware that they might not fit your screen size.</span><br>
    <span>To make the game more visually interesting multiple copies of the field can be displayed adjacent to each other via the <b>array</b> input. If set to e.g. 2x2 a total of four games will be displayed.</span>
    <hr>
    <span><b>Game</b></span><br>
    <span>You can control the games <b>speed</b> by setting a fps, each frame represents 1 iteration. Feel free to go low with fps, it can be fun to see each iteration, usually the game maxes out at 60-90fps.</span>
    <hr>
    <span><b>Start Condition</b></span><br>
    <span>To initiate a game there always needs to be a <b>start condition</b>, an empty gamefield usually does not make a game. This start condition is an image of living cells, a collection of cells that are alive with an age of 0. Those will then be susceptible to the rules defined in the next section. A set of condition generators is availble here, from squares, rectangles, circles, ovals, to arrays of thos (2x2 arrays) and random start conditions.</span><br>
    <span>These conditions can furthermore be startConditionModulatorified by changing their <b>"Size"</b>. With rectangles, squares, circles, ovals, rings and crosses it affects their size in pixels in the most literal sense. For the random generator it changes the density of living cells, where a lower number means more cells. For the vertical and horizontal bars it defines the number of lines.</span>
    <hr>
    <span>GoLTGen is for the most part a standard two-dimensional <a href="https://en.wikipedia.org/wiki/Cellular_automaton" target="_blank">Moore neighborhood Cellular Automaton</a> with the additions of a cells Age (from 0-255) and the Natural Death attribute (When does a cell naturally vanish?).</span><br>
    <span><b>Rules</b></span><br>
    <span>There are three basic sets of rules. When does a cell <b>Survive</b>? When does a cell get <b>born</b>? When does a cell <b>die naturally</b>? The first two rules are represented by a string of literals, e.g. "1, 2, 3", that represent how many neighbours have to be alive to meet this rules condition.</span><br>
    <span>I.e. if the rules for <b>survival</b> are set to "1, 2, 3" then either 1, 2 or three neighbours have to be alive for the cell in question to survive another iteration. If no neighbouring cell is alive, then the cell in question will "starve" and die. If more than 2 neighbouring cells are alive, it will die of "overcrowdedness".</span><br>
    <span>Similarly if a game has a ruleset of "1, 2" for <b>births</b> a cell will be born, switch from dead to alive when it has one or two neighbours that are alive. With no neighbour the cell will stay dead and with more then two neighbours the cell wont come to live due to "overcrowdedness".</span><br>
    <span>Feel free to go crazy with these rules, even a ruleset of 1, 1 for survival, birth can result in an <i>interesting</i> game.</span><br>
    <span>Last but not least the <b>natural death</b> rule, this is a more foreign one to typical cellular automaton implementations, it defines an age at which a cell will vanish naturally and even with otherwise perfectly fine survival conditions. This allows for more interesting games with otherwise static cellular automatons. The maximum age is 255 iterations, while a minimum age will cause the cells to never die, basically disabling this rule. For faster rulesets (e.g. 1, 1) you may choose an early natural death to better map the colour palette, while for many other rulesets a long lifetime might be desirable.</span>
    <hr>
    <span><b>Colors</b></span><br>
    <span>To make this cellular automaton visually interesting we need to map some <b>colors</b> onto it. Since usually there are only two states to a cell, dead or alive, we have added a third state that gives us a more interesting view of a cell, its age! Our display is each cells age mapped onto a colour palette from matplotlib.</span><br>
    <span>The colour-maps can be reverseColormapd by enabling <b>reverseColormap</b></span><br>
    <span>To give you some more control you can re-map each color palette better onto the cells lifetime by changing when in its lifetime the palette should start to change, and when it should stop to change. You can create some dead-banding with this and make the whole game visally less complex, more pleasing.</span>
    <hr>
    <span><b>Controls</b></span><br>
    <span>For when you are in a game you can control it with your keyboard. A game will keep some history, allowing you to go back in time.</span><br>
    <span>Press <kbd>space</kbd> to start or pause a game.</span><br>
    <span>Press <kbd>arrow-right</kbd> to advance one iteration when the game is paused.</span><br>
    <span>Press <kbd>arrow-left</kbd> to reverseColormap one iteration when the game is paused.</span><br>
    <span>Press <kbd>h</kbd> to hide the game-controls</span><br>
    <span>Press <kbd>F5</kbd> to go back to this screen.</span><br>
    <br>
    <span>You can share Games by sharing their link, you can also save games to local storage by giving them a name in game and press save!</span>
  </div>

  <div class="control" id="info">
    <button id="prev">Prev</button>
    <button id="pause">Pause</button>
    <button id="play">Play</button>
    <button id="next">Next</button>
    <span id="timer">&nbsp;</span>
    <span id="generation">&nbsp;</span>
    <div id="info">&nbsp;</div>
    <br>
    <hr>
    <button id="saveGame">Save this Game</button>
    <input id="gameName" name="gameName" type="string" value="" placeholder="..."/>
    <br>
    <hr>
    <span id="controlHint">Press <kbd>h</kbd> to hide this menu </span>
  </div>
  <script src="utils.js"></script>
  <script src="js-colormaps.js"></script>
  <script src="viewer.js"></script>
  <script src="ca.js"></script>
  <script src="user-interface.js"></script>
  <script>
    window.onload = function() {
      function createGame(event) {
        event.preventDefault();
        const data = new FormData(event.target);
        const valuesJSON = Object.fromEntries(data.entries());

        const offscreen = new OffscreenCanvas(valuesJSON.resolutionX, valuesJSON.resolutionY);

        const ca = new CellularAutomaton(
            valuesJSON.resolutionX,
            valuesJSON.resolutionY,
            valuesJSON.survive.split(',').map(function(item) { return parseInt(item, 10); }),
            valuesJSON.birth.split(',').map(function(item) { return parseInt(item, 10); }),
            Math.max(Math.min(valuesJSON.naturalDeath, 255), 0),
            120, // History
            eval(valuesJSON.startCondition),
            valuesJSON.startConditionModulator,
            valuesJSON.neighborhood_size);
        
        const viewer = new Viewer(
            offscreen,
            ca,
            valuesJSON.colormap,
            valuesJSON.reverseColormap,
            valuesJSON.mirrorColormap,
            valuesJSON.arrayX,
            valuesJSON.arrayY,
            Math.max(valuesJSON.colormapStart*2.55, 0),
            Math.min(valuesJSON.colormapStop*2.55, 255));

        const generationCount = document.querySelector('#generation');
        ca.onGenerationChanged = (generation) => {
          generationCount.innerHTML = generation;
          const avg = Math.round((1/(viewer.total_duration/generation))*1000);
          timer.innerHTML = `${avg} fps (${Math.round(1/viewer.last_render_duration*1000)})`;
        };

        window.viewer = viewer;
        viewer.render();

        document.querySelector('#saveGame').onclick = () => {
          let saveGameId = "";
          for (var key in valuesJSON) {      
            saveGameId = saveGameId + valuesJSON[key].toString().replaceAll(',','').replaceAll(' ','');
          }
          const saveGameName = document.getElementById('gameName').value;
          localStorage.setItem(saveGameName, JSON.stringify(valuesJSON));
          document.getElementById('gameName').value = 'Saved as ' + saveGameName + '!';
          setTimeout(clearSaveGameName,600);
        };

        function clearSaveGameName() {
          document.getElementById('gameName').value = ''
        };

        document.getElementById("createGameSettings").style.display="none";
        document.getElementById("tutorial").style.display="none";
        document.getElementById("presets").style.display="none";
        document.getElementById("info").style.display="block";
        window.location.hash = decodeURIComponent(JSON.stringify(valuesJSON))
      }

      presetList = document.getElementById("presetList")
      for(var key in Object.keys(localStorage)) {
          let preset = JSON.parse(localStorage.getItem(Object.keys(localStorage)[key]));
          JSON.parse(localStorage.getItem(Object.keys(localStorage)[key]))
          presetList.innerHTML += '<li> <button id="presetButton" value="' + Object.keys(localStorage)[key] +
            '">Select</button> <b>' + Object.keys(localStorage)[key] + '</b>' +
            '&nbsp;&nbsp;&nbsp;X<span class="presetPreview">' + preset.resolutionX + '</span>' +
            '&nbsp;&nbsp;Y<span class="presetPreview">' + preset.resolutionY + '</span>' +
            '&nbsp;&nbsp;' + preset.startCondition + '' +
            '&nbsp;&nbsp;S<span class="presetPreview">' + preset.survive + '</span>' +
            '&nbsp;&nbsp;B<span class="presetPreview">' + preset.birth + '</span>' +
            '&nbsp;&nbsp;N<span class="presetPreview">' + preset.naturalDeath + '</span>' +
            '&nbsp;&nbsp;' + preset.colormap + '' +
            '</li>\n'
      };

      // Save game
      let buttons = document.querySelectorAll("#presetButton");
      for (let i = 0; i < buttons.length; i++) {
        buttons[i].addEventListener("click", function (e) {
          window.location.hash = decodeURIComponent(localStorage.getItem(Object.keys(localStorage)[i]))
          location.reload();
        });
      }

      // Start Game from Settings
      const createGameForm = document.getElementById("createGameSettings");
      createGameForm.addEventListener('submit', createGame);

      if(window.location.hash != ''){
        document.getElementById("reverseColormap").checked = false;
        document.getElementById("mirrorColormap").checked = false;
        for (const kv of Object.entries(JSON.parse(decodeURIComponent(window.location.hash.substring(1))))){
          const field = document.getElementById(kv[0]);
          if(kv[0] == "reverseColormap" || kv[0] == "mirrorColormap"){
            field.checked = kv[1] == "on" ? true : false;
          } else {
            field.value = kv[1];
          }
        }
        renderGradient();
      }
    }
  </script>
</body>
</html>
