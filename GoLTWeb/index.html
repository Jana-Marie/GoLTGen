<!doctype html>
<html>
<head>
  <title>GoLT with WebGL shader</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <canvas></canvas>

  <div class="control" id="settings">
    <span>X: <input id="xresolution" type="number" style="width: 60px" value="192"/> px&nbsp;&nbsp;</span>
    <span>Y: <input id="yresolution" type="number" style="width: 60px" value="108"/> px&nbsp;&nbsp;</span>
    <span>Array X: <input id="xmult" type="number" style="width: 50px" value="1"/>x&nbsp;&nbsp;</span>
    <span>Array Y: <input id="ymult" type="number" style="width: 50px" value="1"/>x&nbsp;&nbsp;</span>
    <br>
    <span>Speed: <input id="interval" type="number" style="width: 40px" value="50"/> ms&nbsp;&nbsp;</span>
    <span>Birth at: <input id="birth" type="string" style="width: 90px" value="1, 2, 3, 4, 5"/>&nbsp;&nbsp;</span>
    <span>Death at: <input id="death" type="string" style="width: 90px" value="3"/>&nbsp;&nbsp;</span>
    <span>Natural Death at: <input id="ndeath" type="number" style="width: 60px" value="50"/>&nbsp;&nbsp;</span>
    <br>
    <span>Color palette:
      <select id="colormap" style="width: 90px">
        <option value=Accent>Accent</option>
        <option value=Blues>Blues</option>
        <option value=BrBG>BrBG</option>
        <option value=BuGn>BuGn</option>
        <option value=BuPu>BuPu</option>
        <option value=CMRmap>CMRmap</option>
        <option value=Dark2>Dark2</option>
        <option value=GnBu>GnBu</option>
        <option value=Greens>Greens</option>
        <option value=Greys>Greys</option>
        <option value=OrRd>OrRd</option>
        <option value=Oranges>Oranges</option>
        <option value=PRGn>PRGn</option>
        <option value=Paired>Paired</option>
        <option value=Pastel1>Pastel1</option>
        <option value=Pastel2>Pastel2</option>
        <option value=PiYG>PiYG</option>
        <option value=PuBu>PuBu</option>
        <option value=PuBuGn>PuBuGn</option>
        <option value=PuOr>PuOr</option>
        <option value=PuRd>PuRd</option>
        <option value=Purples>Purples</option>
        <option value=RdBu>RdBu</option>
        <option value=RdGy>RdGy</option>
        <option value=RdPu>RdPu</option>
        <option value=RdYlBu>RdYlBu</option>
        <option value=RdYlGn>RdYlGn</option>
        <option value=Reds>Reds</option>
        <option value=Set1>Set1</option>
        <option value=Set2>Set2</option>
        <option value=Set3>Set3</option>
        <option value=Spectral>Spectral</option>
        <option value=Wistia>Wistia</option>
        <option value=YlGn>YlGn</option>
        <option value=YlGnBu>YlGnBu</option>
        <option value=YlOrBr>YlOrBr</option>
        <option value=YlOrRd>YlOrRd</option>
        <option value=afmhot>afmhot</option>
        <option value=autumn>autumn</option>
        <option value=binary>binary</option>
        <option value=bone>bone</option>
        <option value=brg>brg</option>
        <option value=bwr>bwr</option>
        <option value=cividis>cividis</option>
        <option value=cool>cool</option>
        <option value=coolwarm>coolwarm</option>
        <option value=copper>copper</option>
        <option value=cubehelix>cubehelix</option>
        <option value=flag>flag</option>
        <option value=gist_earth>gist_earth</option>
        <option value=gist_gray>gist_gray</option>
        <option value=gist_heat>gist_heat</option>
        <option value=gist_ncar>gist_ncar</option>
        <option value=gist_rainbow>gist_rainbow</option>
        <option value=gist_stern>gist_stern</option>
        <option value=gist_yarg>gist_yarg</option>
        <option value=gnuplot>gnuplot</option>
        <option value=gnuplot2>gnuplot2</option>
        <option value=gray>gray</option>
        <option value=hot>hot</option>
        <option value=hsv>hsv</option>
        <option value=inferno>inferno</option>
        <option value=jet>jet</option>
        <option value=magma>magma</option>
        <option value=nipy_spectral>nipy_spectral</option>
        <option value=ocean>ocean</option>
        <option value=pink>pink</option>
        <option value=plasma>plasma</option>
        <option value=prism>prism</option>
        <option value=rainbow>rainbow</option>
        <option value=seismic>seismic</option>
        <option value=spring>spring</option>
        <option value=summer>summer</option>
        <option value=tab10>tab10</option>
        <option value=tab20>tab20</option>
        <option value=tab20b>tab20b</option>
        <option value=tab20c>tab20c</option>
        <option value=terrain>terrain</option>
        <option value=turbo>turbo</option>
        <option value=twilight>twilight</option>
        <option value=twilight_shifted>twilight_shifted</option>
        <option value=viridis>viridis</option>
        <option value=winter>winter</option>
      </select>&nbsp;&nbsp;
    </span>
    <span>Reverse? <input id="reverse" style="width: 15px; height: 15px;" type="checkbox">&nbsp;&nbsp;</span>
    <span>Start Condition:
      <select id="startcondition" style="width: 90px">
        <option value="randomSeed">Random</option>
        <option value="rectSeed">Rectangle</option>
        <option value="squareSeed">Square</option>
      </select>&nbsp;&nbsp;
    </span>
    <span>Modulator: <input id="mod" type="number" style="width: 40px" value="5"/>&nbsp;&nbsp;</span>
    <br>
    <br>
    <button id="creategame">Create Game</button>
  </div>
   
  <div class="control" id="info">
    <button id="prev">prev</button>
    <button id="pause">pause</button>
    <button id="play">play</button>
    <button id="next">next</button>
    <span id="timer" style="width: 120px; display: inline-block;">&nbsp;</span>
    <span id="generation">&nbsp;</span>
   <!--  <label>
      <input id="render-active" type="checkbox" checked autocomplete="off"> active
    </label>
    <label>
      <input id="render-age" type="checkbox" checked autocomplete="off"> age
    </label>
    <label>
      <input id="render-neighbours" type="checkbox" checked autocomplete="off"> neighbours
    </label> -->
    <div id="info">&nbsp;</div>
    <br>
    <span style="font-size: 14px;">press <kbd>h</kbd> to hide this menu </span>
  </div>

  <script src="utils.js"></script>
  <script src="js-colormaps.js"></script>
  <script src="debug-viewer.js"></script>
  <script src="viewer.js"></script>
  <script src="ca.js"></script>

  <script>
    function rectSeed(board, width, height, mod) {
      for(let i = mod; i < height - mod; i++) {
        for (let j = mod; j < width - mod; j++) {
          board[(i*width+j)*4] = 255;
        }
      }
    }

    function squareSeed(board, width, height, mod) {
      mod = Math.max(mod, 0);
      midX = width/2;
      midY = height/2;
      for(let i = midY-mod; i < midY+mod; i++) {
        for (let j = midX-mod; j < midX+mod; j++) {
          board[(i*width+j)*4] = 255;
        }
      }
    }

    function randomSeed(board, width, height, mod) {
      mod = Math.max(mod, 0);
      mod = Math.min(mod, 100);
      for (let i = 0; i < height; i++) {
        for (let j = 0; j < width; j++) {
          if (Math.random() < mod/100) {
            board[(i*width+j)*4] = 255;
          }
        }
      }
    }
    

    window.onload = function() {
      const canvas = document.querySelector('canvas');
      let playing = false;

      document.querySelector('#creategame').onclick = () => {
        const x = document.querySelector('#xresolution').value;
        const y = document.querySelector('#yresolution').value;
        const mx = document.querySelector('#xmult').value;
        const my = document.querySelector('#ymult').value;

        const birth = document.querySelector('#birth').value.split(',').map(function(item) {
            return parseInt(item, 10);
        });
        const death = document.querySelector('#death').value.split(',').map(function(item) {
            return parseInt(item, 10);
        });
        const ndeath = document.querySelector('#ndeath').value;
        const colormap = document.querySelector('#colormap').value;
        const reverse = document.querySelector('#reverse').value === "on" ? true : false;

        const startcondition = document.querySelector('#startcondition').value;
        console.log(startcondition)
        const mod = document.querySelector('#mod').value;

        const offscreen = new OffscreenCanvas(x, y);

        const ca = new CellularAutomaton(x, y, birth, death, ndeath, 40, eval(startcondition), mod);
        const viewer = new Viewer(offscreen, ca, colormap, reverse, mx, my, 0, 255);

        // const viewer = new Viewer(canvas, ca, (val) => [val, 0, 0, 255]);

        const generationCount = document.querySelector('#generation');
        ca.onGenerationChanged = (generation) => {
          generationCount.innerHTML = generation;
          const avg = Math.round(viewer.total_duration/generation);
          timer.innerHTML = `${viewer.last_render_duration} (${avg})`;
        };

        const interval = document.querySelector('#interval');

        window.viewer = viewer;
        viewer.render();

        document.getElementById("settings").style.display="none";
        document.getElementById("info").style.display="block";
      }

      document.querySelector('#prev').onclick = () => viewer.prev();
      document.querySelector('#next').onclick = () => viewer.next();
      document.querySelector('#play').onclick = () => {
        playing = true;
        viewer.play(parseInt(interval.value));
      }
      document.querySelector('#pause').onclick = () => {
        playing = false;
        viewer.pause();
      }

      window.onkeydown = function(event) {
        if (event.keyCode == 32) {
          event.preventDefault();
          if(document.getElementById("settings").style.display===""){
            document.querySelector('#creategame').click();
          } else {
            if(playing===false){
              document.querySelector('#play').click();
            } else {
              document.querySelector('#pause').click(); 
            }
          }
        } else if (event.keyCode == 37) {
          document.querySelector('#prev').click()
        } else if (event.keyCode == 39) {
          document.querySelector('#next').click()
        }else if (event.keyCode == 72) {
          if(document.getElementById("info").style.display==="block"){
            document.getElementById("info").style.display="none"
          } else {
            document.getElementById("info").style.display="block"
          }
        };
      };
      
      // document.querySelector('#render-active').onchange = (e) => viewer.setRenderActive(e.target.checked);
      // document.querySelector('#render-age').onchange = (e) => viewer.setRenderAge(e.target.checked);
      // document.querySelector('#render-neighbours').onchange = (e) => viewer.setRenderNeighbours(e.target.checked);
      /*
      canvas.onclick = (e) => {
        const rect = e.target.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        const board_x = Math.floor(x / rect.width * ca.width);
        const board_y = Math.floor(y / rect.height * ca.height);
        const info = ca.getCell(board_x, board_y);
        document.getElementById('info').innerHTML = `
            x: ${board_x}, 
            y: ${board_y}, 
            active: ${info.active ? 'yes' : 'no'},
            age: ${info.age},
            neighbours: ${info.neighbours}`;
      }
      */
    }
  </script>
</body>
</html>